## --- filled by configure ----------------------------------------------
ABS_TOP_SRCDIR = @ABS_TOP_SRCDIR@
ABS_RPKG_SRCDIR = @ABS_RPKG_SRCDIR@
ROOT_MINIEXTENDR_REPO = @ROOT_MINIEXTENDR_REPO@
CARGO = @CARGO@
RUSTC = @RUSTC@
RUST_TOOLCHAIN = @RUST_TOOLCHAIN@
CARGO_TARGET_DIR = @CARGO_TARGET_DIR@
CARGO_PROFILE = @CARGO_PROFILE@
CARGO_STATICLIB_NAME = @CARGO_STATICLIB_NAME@
ENV_RUSTFLAGS = @ENV_RUSTFLAGS@
CARGO_BUILD_TARGET = @CARGO_BUILD_TARGET@
CARGO_LIBDIR = @CARGO_LIBDIR@
VENDOR_OUT = @VENDOR_OUT@
CARGO_OFFLINE_FLAG = @CARGO_OFFLINE_FLAG@
CARGO_LOCKED_FLAG = @CARGO_LOCKED_FLAG@
NOT_CRAN_FLAG = @NOT_CRAN@
CARGO_FEATURES_FLAG = @CARGO_FEATURES_FLAG@
OPTIONAL_CARGO_DEPS = @OPTIONAL_CARGO_DEPS@

CARGO_AR = $(CARGO_LIBDIR)/lib$(CARGO_STATICLIB_NAME).a
PKG_LIBS = -L$(CARGO_LIBDIR) -l$(CARGO_STATICLIB_NAME)

R_WRAPPERS_GENERATED = $(ABS_RPKG_SRCDIR)/@PACKAGE_TARNAME@-wrappers.R
R_WRAPPERS_CURRENT   = $(ABS_RPKG_SRCDIR)/../R/@PACKAGE_TARNAME@-wrappers.R

CARGO_LOCK = $(ABS_RPKG_SRCDIR)/rust/Cargo.lock
CARGO_TOML = $(ABS_RPKG_SRCDIR)/rust/Cargo.toml

# Pass Cargo feature flags to C compiler so entrypoint.c knows which modules exist
PKG_CPPFLAGS = @CARGO_FEATURE_CPPFLAGS@
## ----------------------------------------------------------------------

# FORCE_CARGO: phony target to ensure Cargo is invoked every time make runs,
# letting Cargo's own incremental compilation decide what to rebuild.
.PHONY: all clean FORCE_CARGO

# all must be defined FIRST to be the default target
all: $(SHLIB)
	@# Dev mode: touch Cargo.toml so pkgbuild always thinks sources changed
	@if [ "$(NOT_CRAN_FLAG)" = "true" ]; then \
	  touch "$(CARGO_TOML)"; \
	fi
	@# CRAN mode: cleanup vendor and target directories to save space
	@if [ "$(NOT_CRAN_FLAG)" != "true" ]; then \
	  set -e; \
	  if [ -n "$(VENDOR_OUT)" ] && [ -d "$(VENDOR_OUT)" ]; then rm -rf "$(VENDOR_OUT)"; fi; \
	  if [ -d "$(CARGO_TARGET_DIR)" ]; then rm -rf "$(CARGO_TARGET_DIR)"; fi; \
	  if [ -d "$(ABS_RPKG_SRCDIR)/rust/.cargo" ]; then rm -rf "$(ABS_RPKG_SRCDIR)/rust/.cargo"; fi; \
	  if [ -d "$(ABS_TOP_SRCDIR)/rust-target" ]; then rm -rf "$(ABS_TOP_SRCDIR)/rust-target"; fi; \
	  if [ -d "$(ABS_TOP_SRCDIR)/ra-target" ]; then rm -rf "$(ABS_TOP_SRCDIR)/ra-target"; fi; \
	  if [ -d "$(ABS_RPKG_SRCDIR)/rust/target" ]; then rm -rf "$(ABS_RPKG_SRCDIR)/rust/target"; fi; \
	  if [ -d "$(ABS_RPKG_SRCDIR)/rust/ra_target" ]; then rm -rf "$(ABS_RPKG_SRCDIR)/rust/ra_target"; fi; \
	fi

# Phony target to force Cargo invocation (no recipe - just triggers dependents)
FORCE_CARGO:

$(SHLIB): $(OBJECTS) $(CARGO_AR) $(R_WRAPPERS_CURRENT)

# Build the Rust static library
# FORCE_CARGO ensures Cargo is always invoked; Cargo handles incremental builds.
# Note: Dependencies are vendored by configure script, not by this Makefile.
# You must run `./configure` (or `just configure`) before building.
#
# CRAN tarball handling: R CMD build compresses vendor/ into vendor.tar.xz
# to avoid NOTEs about hidden files and long paths. We unpack it here.
VENDOR_TARBALL = $(ABS_TOP_SRCDIR)/inst/vendor.tar.xz

$(CARGO_AR): FORCE_CARGO $(CARGO_TOML) $(CARGO_LOCK) $(ABS_RPKG_SRCDIR)/rust/document.rs $(OPTIONAL_CARGO_DEPS)
	@# Unpack vendor.tar.xz if vendor/ is missing (CRAN tarball case)
	@if [ ! -d "$(VENDOR_OUT)" ] && [ -f "$(VENDOR_TARBALL)" ]; then \
	  echo "Unpacking vendor.tar.xz from inst/..."; \
	  tar -xJf "$(VENDOR_TARBALL)" -C "$(ABS_TOP_SRCDIR)"; \
	fi
	@set -e; \
	TARGET_OPT=""; \
	if [ -n "$(CARGO_BUILD_TARGET)" ]; then TARGET_OPT="--target $(CARGO_BUILD_TARGET)"; fi; \
	RUSTFLAGS="$(ENV_RUSTFLAGS)" \
	$(CARGO) $(RUST_TOOLCHAIN) build $(CARGO_OFFLINE_FLAG) $(CARGO_LOCKED_FLAG) $(CARGO_FEATURES_FLAG) $$TARGET_OPT \
	  --lib --profile $(CARGO_PROFILE) \
	  --manifest-path $(CARGO_TOML) \
	  --target-dir $(CARGO_TARGET_DIR); \
	test -f "$(CARGO_AR)"

# Generate R wrappers from proc-macro output
# FORCE_CARGO ensures the document binary is always run.
$(R_WRAPPERS_GENERATED): FORCE_CARGO $(CARGO_AR) $(CARGO_TOML) $(CARGO_LOCK)
	@set -e; \
	TARGET_OPT=""; \
	if [ -n "$(CARGO_BUILD_TARGET)" ]; then TARGET_OPT="--target $(CARGO_BUILD_TARGET)"; fi; \
	RUSTFLAGS="$(ENV_RUSTFLAGS)" \
	$(CARGO) $(RUST_TOOLCHAIN) run $(CARGO_OFFLINE_FLAG) $(CARGO_LOCKED_FLAG) $(CARGO_FEATURES_FLAG) $$TARGET_OPT \
	  --bin document --profile $(CARGO_PROFILE) \
	  --manifest-path $(CARGO_TOML) \
	  --target-dir $(CARGO_TARGET_DIR); \
	test -f "$(R_WRAPPERS_GENERATED)"

$(R_WRAPPERS_CURRENT): $(R_WRAPPERS_GENERATED)
	@cp "$(R_WRAPPERS_GENERATED)" "$(R_WRAPPERS_CURRENT)"

clean:
	@# Only clean generated files on CRAN (preserve for dev)
	@if [ "$(NOT_CRAN_FLAG)" != "true" ]; then \
	  rm -f "$(R_WRAPPERS_GENERATED)" "$(R_WRAPPERS_CURRENT)"; \
	fi
