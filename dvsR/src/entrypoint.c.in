#include <R.h>
#include <Rinternals.h>
#include <R_ext/Rdynload.h>

// Rust module's init function (lowercase module name)
extern void R_init_@PACKAGE_TARNAME_RS@_miniextendr(DllInfo *dll);

// Rust initialization functions
extern void miniextendr_panic_hook(void);
extern void miniextendr_worker_init(void);

// Set ALTREP package name before ALTREP registration
extern void miniextendr_set_altrep_pkg_name(const char* name);

// Optional vctrs support initialization
// Returns: 0=success, 1=not available, 2=not main thread, 3=already initialized
extern int miniextendr_init_vctrs(void);

// Trait ABI C-callable registration (defined in mx_abi.c)
extern void mx_abi_register(void);

// R_init function uses the ACTUAL R package name (case-sensitive)
void R_init_@PACKAGE_NAME@(DllInfo *dll) {
    miniextendr_panic_hook();
    miniextendr_worker_init();

    // Set ALTREP package name using actual R package name
    miniextendr_set_altrep_pkg_name("@PACKAGE_NAME@");

    // Optional: initialize vctrs C API support
    (void)miniextendr_init_vctrs();

    // Register trait ABI C-callables (mx_wrap, mx_get, mx_query)
    // These are loaded by consumer packages via R_GetCCallable()
    mx_abi_register();

    // Main module's R_init (uses lowercase Rust module name)
    R_init_@PACKAGE_TARNAME_RS@_miniextendr(dll);

    R_useDynamicSymbols(dll, FALSE);
    R_forceSymbols(dll, TRUE);
}
