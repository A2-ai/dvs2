name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  rust-workspace:
    name: Rust workspace (stable)
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}
      - name: Set up Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Install just
        uses: extractions/setup-just@v3
      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep
      - name: Check for std::fs usage
        run: just check-std-fs
      - name: Format check
        id: fmt_check
        continue-on-error: ${{ github.event_name == 'pull_request' }}
        run: just fmt-check
      - name: Auto-format PR on fmt-check failure
        if: steps.fmt_check.outcome == 'failure' && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        env:
          PR_BRANCH: ${{ github.head_ref }}
        run: |
          set -euo pipefail
          just fmt-all
          if git diff --quiet; then
            echo "No formatting changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: fmt"
          git push origin "HEAD:${PR_BRANCH}"
      - name: Re-check formatting after auto-format
        if: steps.fmt_check.outcome == 'failure' && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        run: just fmt-check
      - name: Fail on fmt-check for forked PRs
        if: steps.fmt_check.outcome == 'failure' && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository
        run: |
          echo "fmt-check failed on a forked PR; please run just fmt-all locally."
          exit 1
      - name: Cargo check (warnings as errors)
        env:
          RUSTFLAGS: "-D warnings"
        run: just check
      - name: Clippy (warnings as errors)
        run: just clippy --all-features -- -D warnings
      - name: Tests (default features)
        run: just test
      - name: Tests (all features)
        run: cargo test --manifest-path Cargo.toml --workspace --all-features
      - name: Tests (no default features)
        run: cargo test --manifest-path Cargo.toml --workspace --no-default-features
      - name: dvs-core feature combinations
        run: |
          # Minimal features (just blake3)
          cargo test -p dvs-core --no-default-features --features blake3
          # Without git2-backend (CLI fallback)
          cargo test -p dvs-core --no-default-features --features "blake3,mmap,walkdir"
          # Without mmap (streaming fallback)
          cargo test -p dvs-core --no-default-features --features "blake3,git2-backend,walkdir"
          # Without walkdir (recursive fallback)
          cargo test -p dvs-core --no-default-features --features "blake3,git2-backend,mmap"
      - name: Docs (warnings as errors)
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: cargo doc --manifest-path Cargo.toml --workspace --no-deps

  rust-msrv:
    name: Rust MSRV (1.78.0)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust 1.78.0
        uses: dtolnay/rust-toolchain@1.78.0
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Cargo check (workspace)
        run: cargo check --manifest-path Cargo.toml --workspace
      - name: Clippy (workspace, all features)
        run: cargo clippy --manifest-path Cargo.toml --workspace --all-features -- -D warnings
      - name: Tests (workspace)
        run: cargo test --manifest-path Cargo.toml --workspace

  rust-cross-platform:
    name: Rust tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Cargo check (workspace)
        run: cargo check --manifest-path Cargo.toml --workspace
      - name: Clippy (workspace, all features)
        run: cargo clippy --manifest-path Cargo.toml --workspace --all-features -- -D warnings
      - name: Tests (workspace)
        run: cargo test --manifest-path Cargo.toml --workspace

  rpkg-rust:
    name: dvsR Rust crate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Cargo check (warnings as errors)
        env:
          RUSTFLAGS: "-D warnings"
        run: cargo check --manifest-path dvsR/src/rust/Cargo.toml
      - name: Clippy (warnings as errors)
        run: cargo clippy --manifest-path dvsR/src/rust/Cargo.toml --all-features -- -D warnings
      - name: Tests
        run: cargo test --manifest-path dvsR/src/rust/Cargo.toml

  rust-audit:
    name: Cargo audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Audit dependencies
        uses: actions-rust-lang/audit@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  r-cmd-check:
    name: R CMD check (R=${{ matrix.r-version }}, NOT_CRAN=${{ matrix.not_cran }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        r-version: [oldrel-1, release, devel]
        not_cran: [unset, set]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust (stable)
        uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ matrix.r-version }}
      - name: Install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          working-directory: dvsR
      - name: Build R package
        run: R CMD build dvsR
      - name: Resolve R package tarball
        run: |
          set -euo pipefail
          TARBALL="$(ls -1 dvsR_*.tar.gz | head -n 1)"
          echo "R_PKG_TARBALL=${TARBALL}" >> "$GITHUB_ENV"
      - name: R CMD check (NOT_CRAN unset)
        if: matrix.not_cran == 'unset'
        run: env -u NOT_CRAN R CMD check --as-cran --no-manual "${R_PKG_TARBALL}"
      - name: R CMD check (NOT_CRAN set)
        if: matrix.not_cran == 'set'
        env:
          NOT_CRAN: "true"
        run: R CMD check --as-cran --no-manual "${R_PKG_TARBALL}"
      - name: Upload R CMD check results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: r-cmd-check-${{ matrix.r-version }}-${{ matrix.not_cran }}
          path: |
            *.Rcheck
            dvsR/*.Rcheck
            dvsR/.*.Rcheck
          include-hidden-files: true
          if-no-files-found: warn
