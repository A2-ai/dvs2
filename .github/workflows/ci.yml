name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  rust-workspace:
    name: Rust workspace
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}
      - name: Set up Rust 1.78.0
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.78.0
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Install just
        uses: extractions/setup-just@v3
      - name: Install ripgrep
        run: sudo apt-get update && sudo apt-get install -y ripgrep
      - name: Check for std::fs usage
        run: just check-std-fs
      - name: Format check
        id: fmt_check
        continue-on-error: ${{ github.event_name == 'pull_request' }}
        run: just fmt-check
      - name: Auto-format PR on fmt-check failure
        if: steps.fmt_check.outcome == 'failure' && github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        env:
          PR_BRANCH: ${{ github.head_ref }}
        run: |
          set -euo pipefail
          just fmt-all
          if git diff --quiet; then
            echo "No formatting changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: fmt"
          git push origin "HEAD:${PR_BRANCH}"
      - name: Cargo check
        run: just check
      - name: Clippy
        run: just clippy
      - name: Tests
        run: just test

  r-cmd-check:
    name: R CMD check (NOT_CRAN=${{ matrix.not_cran }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        not_cran: [unset, set]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust 1.85.0
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.85.0
      - uses: Swatinem/rust-cache@v2
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
      - name: Install R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          working-directory: dvsR
      - name: Install just
        uses: extractions/setup-just@v3
      - name: Rust tests for dvsR
        run: just rpkg-test
      - name: R CMD check (NOT_CRAN unset)
        if: matrix.not_cran == 'unset'
        working-directory: dvsR
        run: env -u NOT_CRAN R CMD check --as-cran --no-manual .
      - name: R CMD check (NOT_CRAN set)
        if: matrix.not_cran == 'set'
        working-directory: dvsR
        env:
          NOT_CRAN: "true"
        run: R CMD check --as-cran --no-manual .
